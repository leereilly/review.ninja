<div class="row">
  <!-- the main content area -->
  <div class="col-sm-9 main">
    <div class="row">
      <div class="col-sm-12">
        <p class="lead"><a ui-sref="repo.list({ user:repo.value.owner.login, repo:repo.value.name })">{{ repo.value.full_name }}</a> <a ui-sref="repo.settings({ user:repo.value.owner.login, repo:repo.value.name })"><i class="fa fa-cog"></i></a></p>
        <div class="well row" style="margin: 0px 0px 20px 0px;">
          <div class="col-md-9">
            <h5>
              <button class="btn btn-primary" tooltip-placement="bottom" tooltip-html-unsafe="{{ stargazers.value | stargazerAccumulator }}" ng-click="{true: unstar, false: star}[starred]()"><i class="fa fa-star"></i> {{ {true: 'Unstar', false: 'Star'}[starred] }} ({{ stargazers.value.length }})</button>
              <span>
                <span class="label pull-right" ng-class="{'label-default':status.value==='pending', 'label-success':status.value==='approved', 'label-danger':status.value==='rejected'}">
                  {{ status.value }}
                </span>

                {{ pull.value.title }}
                <span>
                  <img class="img-circle" ng-src="{{ pull.value.user.avatar_url }}" width="18px" />
                  {{ pull.value.user.login }} <small moment="pull.value.created_at"></small>
                  <!-- <img ng-src="/badge/{{ repo.value.owner.login }}/{{ repo.value.name }}/{{ pull.value.head.sha }}"> -->
                </span>
              </span>
            </h5>
          </div>
          <div class="col-md-3">
            <h5>
              <button type="button" ng-show="!pull.value.merged" class="btn btn-primary btn-block" ng-click="merge()"> <!-- popover="{{ {true: 'If it has passed review, you can now merge!', false: 'We strongly encourage to only merge once it\'s passed code review.'}[stargazers.value.length>0] }}" popover-trigger="mouseenter" popover-placement="left" popover-title="{{ {true: 'Can be automatically merged!', false: 'Cannot be automatically merged!'}[pull.value.mergeable] }}" -->
                Merge pull request
              </button>
              <small ng-show="pull.value.merged">This pull request was merged by {{ pull.value.merged_by.login }} <span moment="pull.value.merged_at"></small>
            </h5>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-sm-12">
        <tabset>
        <tab heading="Diff">
          <div class="pull-request-graph">
            <svg version="1.1" class="branch pull-right" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
               viewBox="0 0 300 100" enable-background="new 0 0 300 100" xml:space="preserve" width="200px">
              <path class="git-base" stroke-width="11" stroke-miterlimit="10" d="M 41.1 16.1 L 232.6 16.1"/>
              <polygon class="git-graph-arrow" points="224,4.9 250,16 224,27.4 "/>
              <path class="git-head" stroke-width="11" stroke-miterlimit="10" d="M226.4,78.3c-112.1,0-133.6,1.3-152.8-12.4
                C49.1,48.4,54,22.3,34,15.1"/>
              <filter id="dropshadow" height="130%">
                <feGaussianBlur in="SourceAlpha" stdDeviation="2"/> <!-- stdDeviation is how much to blur -->
                <feMerge> 
                  <feMergeNode/> <!-- this contains the offset blurred image -->
                  <feMergeNode in="SourceGraphic"/> <!-- this contains the element that the filter is applied to -->
                </feMerge>
              </filter>
              <circle class="git-commit active" cx="235.6" cy="78.4" r="13.7" popover="this is the latest commit on the pull request" popover-trigger="mouseenter" popover-append-to-body="true" popover-placement="bottom" />
              <circle class="git-commit" ng-class="{active: currentCommit == pull.value.base.sha}" ng-click="compComm(pull.value.base.sha, pull.value.head.sha)" cx="42.3" cy="16" r="13.7" popover="the pull request is based on this commit" popover-trigger="mouseenter" popover-append-to-body="true" popover-placement="bottom" />
              <circle class="git-commit" ng-show="currentIssue && currentIssue.sha != pull.value.head.sha" ng-class="{active: currentCommit == currentIssue.sha}" ng-click="compComm(currentIssue.sha, pull.value.head.sha)" cx="136.9" cy="78.4" r="13.7" popover="this is where this issue was created" popover-trigger="mouseenter" popover-append-to-body="true" popover-placement="bottom" />
            </svg>
          </div>
          <div class="clearfix"></div>

          <diff ng-repeat="file in files.value" 
                sha="file.sha"
                path="file.filename" 
                patch="file.patch" 
                status="file.status" 
                selected="$parent.$parent.selection"
          </diff>

        </tab>
        <tab heading="Files">
          <browser tree="tree.value" selected="$parent.selection"></browser>
        </tab>
        </tabset>
      </div>
    </div>
  </div>

  <!-- the right sidebar -->
  <div class="col-sm-3 sidebar">
    <button class="btn btn-danger btn-block" ng-click="showNewIssue=!showNewIssue">Create Issue</button>
    <div class="new-issue" ng-show="showNewIssue" ng-init="showNewIssue=false">
      <h5>New Issue</h5>
      <div class="form-group">
        <input ng-model="newIssue.title" ng-init="newIssue.title=''" class="form-control" placeholder="Issue title" />
      </div>
      <div class="form-group">
        <textarea ng-model="newIssue.body" ng-init="newIssue.body=''" class="form-control" placeholder="Issue body..." />
      </div>
      <div class="form-group">
        <button class="form-control btn btn-default" ng-click="createNewIssue()">CREATE</button>
      </div>
    </div>
    <ul class="nav">
      <li class="issue" ng-show="currentIssue != null">
        <a ng-click="setCurrentIssue(null)" href="">
          <span class="fa-stack">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-bars fa-stack-1x fa-inverse"></i>
          </span>
          <span> {{ issue.value.length || 0 }} Issues</span>
        </a></li>
      <li class="issue" ng-repeat="issue in issue.value" ng-show="currentIssue == null || currentIssue == issue">
        <a ng-click="setCurrentIssue(issue)" href="">
          <span class="fa-stack closed-issue" ng-show="issue.state == 'closed'">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-check fa-stack-1x fa-inverse"></i>
          </span>
          <span class="fa-stack open-issue" ng-show="issue.state == 'open'">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-exclamation fa-stack-1x fa-inverse"></i>
          </span>
          <span> {{ issue.title }}</span>
        </a>
        <div ng-show="currentIssue === issue">
          <p class="well">
            {{ currentIssue.body }}
          </p>
          <p ng-repeat="comment in currentIssue.comments.value" class="well">
            {{ comment.body }}
          </p>
          <div class="form-group">
            <textarea class="form-control" placeholder="Comment body..." ng-model="$parent.newCommentBody" ng-class="issue-{{issue.number}}" ng-init="newCommentBody=''"></textarea>
          </div>
          <div class="form-group">
            <button class="btn btn-default btn-block" ng-click="comment(newCommentBody)">Comment</button>
          </div>
          <div class="form-group">
            <button class="btn btn-default btn-block" ng-click="close($index)">Close</button>
          </div>
        </div>
      </li>
    </ul>
  </div>
</div>
